<link rel="import" type="html" href="../../../../vendor/polymer/polymer.html">
<!-- <link rel="import" type="html" href="../vendor/iron-icon/iron-icon.html">
<link rel="import" type="html" href="../vendor/iron-iconset-svg/iron-iconset-svg.html"> -->

<dom-module id="br-selectbox">

  <link rel="import" type="css" href="../dist/br-selectbox.css">   

  <template> 

    <svg style="display:none;">
      <defs>
        <symbol id="icon-check" viewBox="0 0 1024 1024">
          <title>check</title>
          <path d="M384 690l452-452 60 60-512 512-238-238 60-60z"></path>
        </symbol>
        <symbol id="icon-close" viewBox="0 0 1024 1024">
          <title>close</title>
          <path d="M810 274l-238 238 238 238-60 60-238-238-238 238-60-60 238-238-238-238 60-60 238 238 238-238z"></path>
        </symbol>
      </defs>
    </svg>   

    <div class="drop drop__down">
      <button class="drop-toggle" on-click='_toggleSelect'>{{label}}</button>
      <div class="drop-overlay" id="wrap-content">
        <div class="drop-content"> 

          <div class="controls">            
            <button on-click="_closeSelect">
              <svg class="icon icon-check"><use xlink:href="#icon-check"></use></svg>
            </button>
          </div>

          <input type="text" on-keyup='_onKeyPress' placeholder="Digite sua busca">

          <ul class="drop-content-list">
            <template is="dom-repeat" items="{{options}}" >
              <li class="js-drop-content-item" on-click='_onItemSelected' data-value='{{item.key}}' >{{item.value}}</li>
            </template>
          </ul>

        </div>
      </div>

    </div>
  </template>

  <script>
    Polymer({
      is: 'br-selectbox',
      properties: {

        originalOptions: {
          type: Array,
          readyOnly: true
        },

        selectedItems: {
          type: Array,
          readOnly: true,
          value: []
        },

        label: {
          type: String,
          readyOnly: true          
        },

        options: {
          type: Array,
          value: []
        },

        multiselect: {
          type: Boolean,
          value: false
        },

        model: {
          type: Array,
          value: [],
          notify: true
        }
      },

      /* -- Lifecycle ------------------------------------------------- */

      ready: function(){
        this._setOriginalOptions(this.options);
        this.label = 'Selecione';
      },

      /* -- Private Methods ------------------------------------------- */

      _setOriginalOptions: function(options){
        this.originalOptions = options;
      },

      _closeSelect: function(){
        document.getElementById('wrap-content').classList.remove('open');
      },

      _toggleSelect: function(){
        document.getElementById('wrap-content').classList.toggle('open');
      },

      _onKeyPress: function(e) {

        this.options = this._search(this.options, e.target.value);                

        if(!e.target.value.trim())
         this.options = this.originalOptions;
      },

     _onItemSelected: function(e){

        if(this._isMultiSelect()){

         if(e.target.classList.contains('is_selected')){

          var index = this._arrayObjectIndexOf(this.selectedItems, e.target.dataValue, "key");
          e.target.classList.remove('is_selected');
          this.selectedItems.splice(index, 1);

        }else{

          var isDuplicated = this.selectedItems.some(function(item) {
            return item.id === e.target.dataValue;
          });

          if(!isDuplicated)
            this.selectedItems.push({ "key": e.target.dataValue, "value": e.target.innerText });

          e.target.classList.add('is_selected');          
        }

        if(this.selectedItems.length > 0)
          this.label = '( ' + this.selectedItems.length + ' Selecionados ) ';
        else
          this.label = 'Selecione';

      }else{
        this._unselectAll();
        e.target.classList.toggle('is_selected');
        this.label = e.target.innerText;
        this._closeSelect();
        this.selectedItems.push({ "key": e.target.dataValue, "value": e.target.innerText });
      }

      this.model = this.selectedItems;

    },

    _isMultiSelect: function(){
      return this.multiselect;
    },

    _unselectAll: function()  {

     var items = document.getElementsByClassName('js-drop-content-item');

     for (var i = 0; i < items.length; i++)
      items[i].classList.remove('is_selected');

    this.selectedItems.splice(0, this.selectedItems.length);

    },

    _arrayObjectIndexOf: function(myArray, searchTerm, property) {

      for(var i = 0, len = myArray.length; i < len; i++) {
        if (myArray[i][property] === searchTerm) return i;
      }
      return -1;
    },

    _search: function(collection, query){

      return collection.filter(function(value, index, array){
        return array[index].value.toLowerCase().indexOf(query.toLowerCase()) !== -1;
      });

    }

     /* -- Public Methods -------------------------------------------- */

   });
  </script>

</dom-module>